# 設定 Google Apps Script 每天自動執行

## 📅 設定自動觸發器（Trigger）

讓 `updateAllConsecutiveDays` 函數每天自動執行，無需手動操作。

---

## 🎯 步驟 1: 開啟 Apps Script 編輯器

1. 開啟你的 Google Sheet
2. 點擊頂部選單「**擴充功能**」→「**Apps Script**」
3. 進入 Apps Script 編輯器

---

## ⏰ 步驟 2: 新增時間觸發器

### 方法一：圖形化介面設定（推薦）

1. **在 Apps Script 編輯器左側，點擊「觸發條件」圖示**
   - 圖示看起來像一個「**時鐘 ⏰**」
   - 或直接點擊左側選單的「**Triggers**」（英文介面）

2. **點擊右下角「+ 新增觸發條件」按鈕**

3. **設定觸發條件**，依序填入：

   | 欄位 | 設定值 | 說明 |
   |-----|-------|------|
   | **選擇要執行的函式** | `updateAllConsecutiveDays` | 要自動執行的函數 |
   | **選擇活動來源** | `時間驅動` | 依時間自動執行 |
   | **選取時間型觸發條件類型** | `日計時器` | 每天執行一次 |
   | **選取時段** | `午夜 12 時至上午 1 時` | 凌晨執行（推薦） |

   **推薦時段**：
   - ✅ **午夜 12 時至上午 1 時**：最佳選擇，當天所有打卡都已完成
   - ✅ **上午 1 時至 2 時**：備選
   - ❌ 避免選擇白天時段，可能影響學員查看資料的速度

4. **點擊「儲存」**

5. **授權確認**
   - 第一次設定時，Google 會要求授權
   - 點擊「**檢閱權限**」
   - 選擇你的 Google 帳號
   - 點擊「**允許**」

6. **完成！**
   - 你會在「觸發條件」列表中看到剛剛建立的觸發器
   - 狀態顯示為「已啟用」

---

### 方法二：程式碼設定（進階）

如果你熟悉程式碼，也可以用程式碼建立觸發器：

1. 在 Apps Script 編輯器中，新增以下函數：

```javascript
/**
 * 建立每日自動觸發器
 * 只需執行一次即可
 */
function createDailyTrigger() {
  // 先刪除舊的觸發器（避免重複）
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'updateAllConsecutiveDays') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // 建立新的每日觸發器（每天凌晨 1-2 點執行）
  ScriptApp.newTrigger('updateAllConsecutiveDays')
    .timeBased()
    .atHour(1) // 凌晨 1 點
    .everyDays(1) // 每天
    .create();

  SpreadsheetApp.getUi().alert('每日自動觸發器已建立！\n\n每天凌晨 1-2 點會自動更新連續打卡天數。');
}
```

2. 儲存後，在函數下拉選單選擇 `createDailyTrigger`
3. 點擊「執行」
4. 完成！

---

## ✅ 步驟 3: 驗證觸發器已建立

### 檢查觸發器狀態

1. 在 Apps Script 編輯器左側，點擊「**觸發條件**」
2. 你應該會看到一個觸發器，內容如下：

   | 欄位 | 值 |
   |-----|---|
   | 函式 | updateAllConsecutiveDays |
   | 活動來源 | 時間驅動 |
   | 類型 | 日計時器 |
   | 時段 | 午夜 12 時至上午 1 時 |
   | 失敗通知設定 | 立即通知我 |

3. 狀態顯示為「**已啟用**」✅

---

## 📧 步驟 4: 設定失敗通知（可選）

當觸發器執行失敗時，Google 會寄信通知你。

1. 在「觸發條件」頁面
2. 點擊觸發器右側的「⋯」（三個點）
3. 選擇「**失敗通知設定**」
4. 選擇「**立即通知我**」
5. 儲存

這樣如果執行出錯，你會立即收到 Email 通知。

---

## 🧪 步驟 5: 測試觸發器

### 手動測試函數是否正常

在等待每日自動執行之前，先手動測試一次：

1. 在 Apps Script 編輯器
2. 函數下拉選單選擇 `updateAllConsecutiveDays`
3. 點擊「執行」
4. 等待執行完成
5. 回到 Google Sheet 的「打卡統計」工作表
6. 檢查 C 欄（連續打卡天數）是否已更新

如果正常運作，表示觸發器也會正常自動執行。

---

## 📊 查看執行記錄

### 檢查觸發器是否有自動執行

1. 在 Apps Script 編輯器左側，點擊「**執行作業**」（圖示像一個播放按鈕）
2. 你會看到所有執行記錄，包括：
   - 執行時間
   - 觸發方式（手動 / 時間驅動）
   - 執行狀態（成功 / 失敗）
   - 執行時間長度

**範例**：
```
2026-01-10 01:23:45  時間驅動  updateAllConsecutiveDays  已完成  6.2 秒
2026-01-09 01:15:32  時間驅動  updateAllConsecutiveDays  已完成  5.8 秒
```

---

## 🔧 常見問題

### Q1: 觸發器沒有自動執行？

**檢查項目**：
1. 確認觸發器狀態為「已啟用」
2. 查看「執行作業」是否有錯誤記錄
3. 檢查是否有收到失敗通知 Email
4. 確認函數名稱拼寫正確：`updateAllConsecutiveDays`

### Q2: 執行失敗，收到錯誤通知 Email？

**常見原因**：
1. **工作表名稱錯誤**：確認「表單回應」和「打卡統計」工作表名稱正確
2. **授權過期**：重新授權觸發器
3. **資料格式錯誤**：檢查「表單回應」的資料是否正常

**解決方法**：
- 查看「執行作業」的詳細錯誤訊息
- 手動執行函數測試
- 根據錯誤訊息修正問題

### Q3: 想要改變執行時間？

1. 在「觸發條件」頁面
2. 點擊觸發器右側的「⋯」
3. 選擇「**編輯**」
4. 修改「選取時段」
5. 儲存

### Q4: 想要刪除觸發器？

1. 在「觸發條件」頁面
2. 點擊觸發器右側的「⋯」
3. 選擇「**刪除觸發器**」
4. 確認刪除

### Q5: 可以設定每小時執行嗎？

可以，但**不建議**：
- 改為「選取時間型觸發條件類型」→「**每小時計時器**」
- 但學員的連續天數是以「天」為單位，每小時更新沒有意義
- 且會增加 Google Apps Script 的配額使用量

**建議**：每天執行一次即可。

---

## 💡 進階設定

### 設定多個時段備援

如果擔心某個時段執行失敗，可以設定兩個觸發器：

1. **主要觸發器**：凌晨 1-2 點
2. **備援觸發器**：上午 8-9 點

這樣即使凌晨執行失敗，上午還會再執行一次。

**注意**：函數中已經處理了重複執行的情況，不會重複計算。

---

## 📅 Google Apps Script 配額

免費版 Google Apps Script 的配額：

| 項目 | 免費版限制 |
|-----|----------|
| 每日執行時間 | 90 分鐘/天 |
| 單次執行時間 | 6 分鐘 |
| 觸發器數量 | 20 個/專案 |

**我們的使用情況**：
- `updateAllConsecutiveDays` 執行時間：約 5-10 秒（100 位學員）
- 每天執行 1 次
- 每日使用時間：< 0.2% 的配額

**結論**：完全沒問題！✅

---

## ✅ 設定完成檢查清單

- [ ] 已建立時間觸發器
- [ ] 觸發器狀態為「已啟用」
- [ ] 已設定失敗通知
- [ ] 已手動測試函數正常運作
- [ ] 已確認「打卡統計」C 欄會更新

全部勾選後，你的自動執行就設定完成了！🎉

---

## 🎯 總結

**設定步驟**：
1. 開啟 Apps Script 編輯器
2. 左側點擊「觸發條件」（時鐘圖示）
3. 點擊「+ 新增觸發條件」
4. 設定為每天凌晨執行 `updateAllConsecutiveDays`
5. 儲存並授權
6. 完成！

**之後每天凌晨，系統會自動更新所有學員的連續打卡天數，完全不需要手動操作！** ✨

有任何問題隨時告訴我！
