# 連續打卡天數都是 0 - 問題診斷步驟

## 快速診斷

我已經在 Code_CLEAN.js 中加入了詳細的 debug 訊息，請按照以下步驟診斷問題：

---

## 步驟 1：檢查工作表名稱

Code_CLEAN.js 第 191-192 行使用的工作表名稱：
```javascript
const responseSheet = ss.getSheetByName('表單回應');
const statsSheet = ss.getSheetByName('打卡統計');
```

**請確認你的 Google Sheets 工作表名稱：**
- [ ] 是否有「**表單回應**」工作表？
- [ ] 是否有「**打卡統計**」工作表？（或是叫「**學員打卡統計**」？）

**如果名稱不符：**
- 修改 Code_CLEAN.js 第 192 行為你實際的工作表名稱
- 例如：`const statsSheet = ss.getSheetByName('學員打卡統計');`

---

## 步驟 2：執行腳本並查看 Log

1. **在 Google Apps Script 中執行「更新連續天數」**
   - 打開 Google Sheets
   - 點選「打卡系統」選單 → 「🔄 更新連續天數」

2. **查看執行記錄**
   - 在 Apps Script 編輯器中
   - 點選左側的「執行作業」（時鐘圖示）
   - 點擊最新的執行記錄
   - 查看完整的 Log 輸出

---

## 步驟 3：分析 Log 輸出

### 檢查點 1：資料讀取

**Log 應該顯示：**
```
從「表單回應」讀取到 X 筆資料（不含標題）
從「打卡統計」讀取到 X 位學員（不含標題）
```

**診斷：**
- ❌ 如果顯示 `0 筆資料` → **問題：工作表沒有資料**
- ❌ 如果顯示錯誤訊息 → **問題：工作表名稱錯誤**
- ✅ 如果顯示正確的數字 → 繼續下一步

---

### 檢查點 2：表單回應範例

**Log 應該顯示：**
```
--- 前 3 筆表單回應資料範例 ---
  第 1 筆:
    C欄(姓名): 學員001
    D欄(打卡日期): 2026/01/01 09:00:00
    E欄(是否完成): ✅ 是，已完成
```

**診斷：**
- ❌ 如果 C欄 顯示 `undefined` → **問題：欄位位置不對（姓名不在 C 欄）**
- ❌ 如果 D欄 顯示 `undefined` → **問題：打卡日期不在 D 欄**
- ❌ 如果 E欄 不是 `✅ 是，已完成` → **問題：狀態文字不符**
- ✅ 如果所有欄位都正確 → 繼續下一步

---

### 檢查點 3：截止日期

**Log 應該顯示：**
```
今天日期: 2025-12-21
截止日期: 2025-12-21 23:59:59
（只計算截止日期之前的打卡記錄，忽略之後的測試數據）
```

**診斷：**
- ⚠️ 如果截止日期 < 你的打卡日期 → **問題：所有資料都被過濾掉了**
  - 例如：截止日期是 2025-12-21，但打卡日期都是 2026-01-xx
  - **解決方法：** 修改 TEST_TODAY_DATE 或改為 null

---

### 檢查點 4：studentRecords 內容

**Log 應該顯示：**
```
==================== studentRecords 內容 ====================
  學員001: 16 天打卡
    日期: 2026-01-01, 2026-01-02, 2026-01-03, ...
  學員002: 13 天打卡
    日期: 2026-01-01, 2026-01-02, ...
===========================================================
```

**診斷：**
- ❌ 如果顯示 `⚠️ studentRecords 是空的！` → **關鍵問題！**
  - **原因 1：** E 欄狀態不是「✅ 是，已完成」
  - **原因 2：** 截止日期設定錯誤，所有資料都被過濾
  - **原因 3：** 「表單回應」工作表沒有資料
- ✅ 如果顯示學員的打卡日期 → 繼續下一步

---

### 檢查點 5：計算過程

**Log 應該顯示：**
```
==================== 開始計算連續天數 ====================
statsData 總共有 5 位學員（不含標題）
--- 處理學員 1: 學員001 ---
  從 studentRecords 讀到的打卡天數: 16
  不重複打卡日期數: 16
  最舊打卡: 2026-01-01
  最新打卡: 2026-01-16
  🏆 最高連續打卡天數: 16 天
```

**診斷：**
- ❌ 如果顯示 `從 studentRecords 讀到的打卡天數: 0` → **問題：學員名稱不匹配**
  - 「打卡統計」中的學員名稱 vs 「表單回應」中的學員名稱不一致
- ✅ 如果顯示正確的計算過程 → 應該能正確寫入

---

## 常見問題與解決方法

### 問題 1：工作表名稱錯誤

**錯誤訊息：**
```
TypeError: Cannot read property 'getDataRange' of null
```

**解決方法：**
1. 檢查 Google Sheets 的工作表標籤名稱
2. 修改 Code_CLEAN.js 第 191-192 行為正確的名稱

---

### 問題 2：截止日期過濾掉所有資料

**Log 顯示：**
```
已過濾掉 46 筆截止日期之後的記錄
⚠️ studentRecords 是空的！
```

**解決方法：**

修改 Code_CLEAN.js 第 27 行：
```javascript
// 改為 null 使用真實日期
const TEST_TODAY_DATE = null;

// 或改為你的資料日期範圍內
const TEST_TODAY_DATE = new Date('2026-01-16');
```

---

### 問題 3：E 欄狀態文字不符

**可能的狀態文字：**
- ✅ `✅ 是，已完成` （正確）
- ❌ `是` （不符）
- ❌ `已完成` （不符）
- ❌ `Yes` （不符）

**檢查方法：**
1. 打開「表單回應」工作表
2. 查看 E 欄的實際文字
3. 確保完全一致（包含 emoji 和標點符號）

**解決方法：**
- 如果格式不同，修改 Code_CLEAN.js 第 245 行：
```javascript
if (status === "你實際的狀態文字") {
```

---

### 問題 4：學員名稱不匹配

**Log 顯示：**
```
--- 處理學員 1: 學員A ---
  從 studentRecords 讀到的打卡天數: 0
```

**原因：**
- 「打卡統計」中是「學員A」
- 「表單回應」中是「學員 A」（有空格）
- 或「學員a」（大小寫不同）

**解決方法：**
1. 統一「打卡統計」和「表單回應」中的學員名稱
2. 確保完全一致（包含空格、大小寫）

---

### 問題 5：欄位位置錯誤

**如果你的表單結構是：**
- A 欄：時間戳記
- B 欄：電子郵件
- **C 欄：打卡日期**（而非姓名）
- **D 欄：姓名**（而非打卡日期）

**解決方法：**

修改 Code_CLEAN.js 第 241-243 行：
```javascript
// 根據你的實際欄位位置調整
const name = row[3]; // 改為你的姓名欄位索引
const dateValue = row[2]; // 改為你的打卡日期欄位索引
const status = row[4]; // 改為你的是否完成欄位索引
```

---

## 診斷流程圖

```
執行「更新連續天數」
        ↓
查看 Log 輸出
        ↓
┌───────────────────────┐
│ 讀取到幾筆資料？      │
└───────────────────────┘
        ↓
   是否 > 0？
    ↙      ↘
  否        是
   ↓         ↓
工作表名稱   查看 E 欄狀態
錯誤或      是否正確？
沒有資料     ↙      ↘
           否        是
            ↓         ↓
          修改       查看截止日期
          狀態       是否過濾掉？
          判斷        ↙      ↘
                    否        是
                     ↓         ↓
                  查看       修改
                  學員       TEST_TODAY_DATE
                  名稱
                  是否
                  匹配？
```

---

## 下一步

**完成診斷後，請回報以下資訊：**

1. **Log 輸出的關鍵部分：**
   - 讀取到幾筆資料？
   - 前 3 筆表單回應範例是什麼？
   - studentRecords 是空的還是有資料？

2. **你的工作表結構：**
   - 各欄位的位置（A, B, C, D...）
   - E 欄的實際文字內容

3. **TEST_TODAY_DATE 設定：**
   - 目前設定的日期是什麼？
   - 你的打卡資料日期範圍是什麼？

有了這些資訊，我們就能快速定位並解決問題！
