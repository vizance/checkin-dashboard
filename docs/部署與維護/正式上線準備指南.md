# 正式上線準備指南

> ⚠️ **重要更新（2026-01-16）**
> 系統已改為「最高連續打卡」邏輯，詳見：[更新說明_最高連續打卡.md](./更新說明_最高連續打卡.md)

## 概述

本指南將幫助你從測試環境切換到正式環境，確保系統在實際課程中正常運作。

## 核心概念：TEST_TODAY_DATE 的運作方式

### 什麼是 TEST_TODAY_DATE？

TEST_TODAY_DATE 是一個「時間旅行」機制，讓你可以模擬任意日期來測試系統功能。

**測試模式：**
```javascript
export const TEST_TODAY_DATE = new Date('2026-01-16');  // 假裝今天是 2026-01-16
```

**正式模式：**
```javascript
export const TEST_TODAY_DATE = null;  // 使用真實的今天日期
```

### 在程式碼中的使用方式

所有需要「今天日期」的地方，都統一使用以下模式：

```javascript
const today = TEST_TODAY_DATE ? new Date(TEST_TODAY_DATE) : new Date();
```

這樣的設計有以下優點：
1. **測試方便**：設定 TEST_TODAY_DATE 就能模擬任意日期
2. **切換簡單**：只需修改一個地方（config.js）就能切換測試/正式模式
3. **不需要例外處理**：前後端使用相同邏輯，不需要為測試寫特殊代碼

---

## 需要修改的文件清單

### 1. 前端：js/config.js

**當前設定（測試模式）：**
```javascript
export const COURSE_START_DATE = new Date('2025-12-07');
export const TEST_TODAY_DATE = new Date('2025-12-21');
```

**正式上線修改為：**
```javascript
export const COURSE_START_DATE = new Date('2026-01-13');  // 你的實際課程開始日期
export const TEST_TODAY_DATE = null;  // 改為 null，使用真實日期
```

**檔案位置：** `/js/config.js`（第 16, 21 行）

---

### 2. 後端：Google Apps Script（Code_CLEAN.js）

**當前設定（測試模式）：**
```javascript
const TEST_TODAY_DATE = '2025-12-21';
const COURSE_START_DATE = new Date('2025-12-07');
```

**正式上線修改為：**
```javascript
const TEST_TODAY_DATE = null;  // 改為 null
const COURSE_START_DATE = new Date('2026-01-13');  // 實際課程開始日期
```

**檔案位置：** Google Apps Script（Code_CLEAN.js，第 18, 22 行）

**重要提示：**
- 修改完後，記得在 Google Apps Script 中點擊「部署」→「新增部署」
- 確保 Web 應用程式的「執行身分」設定正確

---

### 3. 週報腳本：WeeklyReport.js

**當前設定（測試模式）：**
```javascript
const TEST_TODAY_DATE = '2025-12-21';
const COURSE_START_DATE = new Date('2025-12-07');
```

**正式上線修改為：**
```javascript
const TEST_TODAY_DATE = null;  // 改為 null
const COURSE_START_DATE = new Date('2026-01-13');  // 實際課程開始日期
```

**檔案位置：** Google Apps Script（WeeklyReport.js，第 26, 29 行）

---

## 正式上線步驟（按順序執行）

### 第一步：清空測試資料

1. **打開 Google Sheets**
   - 打開你的「5 週復盤陪跑班」試算表

2. **清空「表單回應」工作表**
   - 保留標題列（第一列）
   - 刪除所有測試資料（第 2 列以下）

3. **清空「學員打卡統計」工作表**
   - 完全清空（包含標題）
   - 因為這個工作表會由 Apps Script 自動重新生成

4. **設定「學員名單」工作表**
   - 在「學員名單」工作表中，輸入所有實際學員的姓名（一列一個）
   - 這些名單會自動同步到 Google 表單的下拉選單

---

### 第二步：更新 Google Apps Script

1. **打開 Apps Script 編輯器**
   - 在 Google Sheets 中，點選「擴充功能」→「Apps Script」

2. **更新 Code_CLEAN.js**
   ```javascript
   // 修改這兩行
   const TEST_TODAY_DATE = null;  // 改為 null
   const COURSE_START_DATE = new Date('2026-01-13');  // 你的實際開始日期
   ```

3. **更新 WeeklyReport.js**
   ```javascript
   // 修改這兩行
   const TEST_TODAY_DATE = null;  // 改為 null
   const COURSE_START_DATE = new Date('2026-01-13');  // 你的實際開始日期
   ```

4. **儲存並部署**
   - 點擊「儲存專案」
   - 點擊「部署」→「管理部署」
   - 選擇現有部署，點擊「編輯」
   - 選擇「新版本」
   - 點擊「部署」

---

### 第三步：更新前端設定

1. **修改 js/config.js**
   ```javascript
   export const COURSE_START_DATE = new Date('2026-01-13');  // 實際開始日期
   export const TEST_TODAY_DATE = null;  // 改為 null
   ```

2. **清除瀏覽器緩存**
   - 打開網站的開發者工具（F12）
   - 在 Console 中執行：
   ```javascript
   localStorage.clear();
   location.reload(true);
   ```
   - 或使用專用清除腳本：clear-cache.js

3. **重新上傳檔案**（如果你是透過 GitHub Pages 或其他託管服務）
   - 將修改後的 js/config.js 上傳到伺服器

---

### 第四步：設定自動化觸發器

1. **在 Apps Script 中設定觸發器**
   - 在 Apps Script 編輯器中，點擊左側的「觸發條件」（時鐘圖示）

2. **設定每日統計更新**
   - 點擊「新增觸發條件」
   - 選擇函式：`updateDailyStats`
   - 部署作業：選擇「Head」
   - 活動來源：「時間驅動」
   - 時間型觸發條件：「日計時器」
   - 時段：選擇「晚上 11 點到凌晨 12 點」（建議在一天結束時更新）
   - 點擊「儲存」

3. **設定每週報告（可選）**
   - 如果要使用自動每週報告功能
   - 點擊「新增觸發條件」
   - 選擇函式：`sendWeeklyReports`
   - 部署作業：選擇「Head」
   - 活動來源：「時間驅動」
   - 時間型觸發條件：「週計時器」
   - 星期：選擇「每週日」（或你想要的日子）
   - 時段：選擇適合的時間
   - 點擊「儲存」

---

### 第五步：測試驗證

完成上述設定後，進行以下測試：

#### 1. 測試 Google 表單
- 開啟你的打卡表單
- 檢查「姓名」下拉選單是否顯示正確的學員名單
- 提交一筆測試資料
- 確認資料正確出現在「表單回應」工作表

#### 2. 測試 Apps Script 計算
- 在 Apps Script 編輯器中，手動執行 `updateDailyStats`
- 檢查「學員打卡統計」工作表是否正確生成
- 確認日期、累計天數、連續天數等資料正確

#### 3. 測試儀表板前端
- 打開儀表板網站
- 按 F12 打開開發者工具，查看 Console
- 確認沒有錯誤訊息
- 檢查以下功能：
  - ✅ 今日日期顯示正確（不是測試日期）
  - ✅ 熱力圖顯示正確
  - ✅ 連續打卡王排行榜正確
  - ✅ 今日亮點牆顯示正確
  - ✅ 個人查詢功能正常

#### 4. 測試快取機制
- 重新整理頁面
- 確認資料從快取載入（Console 會顯示 "使用快取資料"）
- 5 分鐘後再次重新整理
- 確認資料從遠端重新載入（Console 會顯示 "從遠端載入資料"）

---

## 檢查清單

在正式開課前，請逐項確認：

### Google Sheets
- [ ] 「表單回應」工作表：只有標題列，無測試資料
- [ ] 「學員打卡統計」工作表：已清空
- [ ] 「學員名單」工作表：包含所有實際學員姓名

### Google Apps Script
- [ ] Code_CLEAN.js：`TEST_TODAY_DATE = null`
- [ ] Code_CLEAN.js：`COURSE_START_DATE` 設定為實際開始日期
- [ ] WeeklyReport.js：`TEST_TODAY_DATE = null`
- [ ] WeeklyReport.js：`COURSE_START_DATE` 設定為實際開始日期
- [ ] 已部署新版本（記得選擇「新版本」）
- [ ] 觸發器已設定：每日統計更新

### 前端檔案
- [ ] js/config.js：`TEST_TODAY_DATE = null`
- [ ] js/config.js：`COURSE_START_DATE` 設定為實際開始日期
- [ ] 瀏覽器快取已清除
- [ ] 檔案已上傳到伺服器（如果適用）

### 功能測試
- [ ] 表單提交測試通過
- [ ] Apps Script 計算測試通過
- [ ] 儀表板顯示測試通過
- [ ] 日期顯示為今天（非測試日期）
- [ ] 快取機制運作正常

---

## 常見問題

### Q1: 修改 TEST_TODAY_DATE 後，為什麼前端還是顯示舊日期？

**A:** 需要清除瀏覽器快取。執行以下步驟：
1. 開啟開發者工具（F12）
2. 在 Console 中執行：`localStorage.clear();`
3. 按 Ctrl+Shift+R（或 Cmd+Shift+R）強制重新載入

### Q2: 修改 Apps Script 後，為什麼統計資料沒變化？

**A:** 需要部署新版本。步驟：
1. 在 Apps Script 中，點擊「部署」→「管理部署」
2. 點擊現有部署旁的「編輯」
3. **重要：選擇「新版本」**
4. 點擊「部署」

### Q3: 如果我想在正式環境中測試某個未來日期怎麼辦？

**A:** 你可以暫時設定 TEST_TODAY_DATE 為未來日期，測試完後再改回 null。這就是這個設計的優勢所在！

### Q4: 前後端的 TEST_TODAY_DATE 一定要一致嗎？

**A:** 是的！前後端必須使用相同的日期設定，否則會導致資料不一致。建議：
- 兩邊都設定為 null（正式模式）
- 或兩邊都設定為相同的測試日期（測試模式）

### Q5: 課程開始後，還能修改 COURSE_START_DATE 嗎？

**A:** 不建議！COURSE_START_DATE 會影響：
- 35 天挑戰進度計算
- 熱力圖顯示
- 個人打卡日曆

如果真的需要修改，必須同時修改前後端，並清除所有快取。

---

## 測試資料管理建議

### 方案一：使用測試 Google Sheet（推薦）

1. 複製一份 Google Sheets 作為測試用
2. 測試時使用測試 Sheet 的 ID
3. 正式上線時切換回正式 Sheet 的 ID

**優點：**
- 測試與正式資料完全隔離
- 可以保留測試資料供未來參考

**缺點：**
- 需要管理兩份試算表

### 方案二：使用 TEST_TODAY_DATE 時間旅行

1. 保持正式資料在 Google Sheets
2. 設定 TEST_TODAY_DATE 為過去或未來日期來測試
3. 測試完成後設定 TEST_TODAY_DATE = null

**優點：**
- 只需管理一份試算表
- 可以模擬任意日期場景

**缺點：**
- 測試時需小心不要誤刪正式資料

### 方案三：混合使用

1. 開課前使用測試 Sheet + TEST_TODAY_DATE
2. 開課後只使用 TEST_TODAY_DATE（必要時）
3. 正常運作時 TEST_TODAY_DATE = null

---

## 緊急回滾方案

如果正式上線後發現問題，快速回到可用狀態：

### 1. 前端緊急修復
```javascript
// 在 js/config.js 中暫時切換回測試模式
export const TEST_TODAY_DATE = new Date('2026-01-16');  // 設定為當天
```

### 2. 後端緊急修復
```javascript
// 在 Apps Script 中暫時切換回測試模式
const TEST_TODAY_DATE = '2026-01-16';  // 設定為當天
```

### 3. 清除錯誤資料
- 如果產生錯誤的統計資料，刪除「學員打卡統計」工作表所有資料
- 重新執行 `updateDailyStats`

---

## 技術架構說明（供開發者參考）

### 日期處理流程

```
1. 前端 (dashboard.js)
   ↓
   使用 TEST_TODAY_DATE ? new Date(TEST_TODAY_DATE) : new Date()
   ↓
   計算今日打卡、熱力圖、進度等
   ↓
   顯示在網頁上

2. 後端 (Code_CLEAN.js)
   ↓
   使用 TEST_TODAY_DATE ? new Date(TEST_TODAY_DATE) : new Date()
   ↓
   過濾 cutoffDate 之後的記錄
   ↓
   計算累計天數、連續天數
   ↓
   寫入「學員打卡統計」工作表
   ↓
   前端透過 CSV 匯出讀取統計資料
```

### 為什麼使用 null 而非 undefined？

```javascript
// ❌ 錯誤：undefined 在三元運算中會被視為 falsy
const TEST_TODAY_DATE = undefined;
const today = TEST_TODAY_DATE ? new Date(TEST_TODAY_DATE) : new Date();
// 結果：會使用 new Date()（正確）

// ✅ 正確：null 在三元運算中被視為 falsy，且語意更明確
const TEST_TODAY_DATE = null;
const today = TEST_TODAY_DATE ? new Date(TEST_TODAY_DATE) : new Date();
// 結果：會使用 new Date()（正確）

// ✅ 測試模式：明確的日期字串
const TEST_TODAY_DATE = '2026-01-16';
const today = TEST_TODAY_DATE ? new Date(TEST_TODAY_DATE) : new Date();
// 結果：會使用 new Date('2026-01-16')
```

### 快取機制

```javascript
// 快取策略
const CACHE_DURATION = 5 * 60 * 1000;  // 5 分鐘

// 讀取順序：
1. 檢查 localStorage 是否有快取
2. 檢查快取是否過期（時間戳 + CACHE_DURATION < 現在時間）
3. 如果有效 → 使用快取
4. 如果無效或不存在 → 從 Google Sheets CSV 匯出載入
5. 儲存新資料到 localStorage
```

---

## 聯絡與支援

如果在上線過程中遇到問題，請檢查：

1. **Console 錯誤訊息**（F12 開發者工具）
2. **Apps Script 執行記錄**（在 Apps Script 編輯器中查看「執行作業」）
3. **Google Sheets 資料格式**（確認日期格式正確）

記得：TEST_TODAY_DATE 是你的好幫手，遇到問題時可以設定為特定日期來重現錯誤！
