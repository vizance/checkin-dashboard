# 更新說明：改為「最高連續打卡」邏輯

📅 **更新日期：** 2026-01-16

---

## 主要變更

### 從「當前連續」改為「最高連續」

**舊邏輯：**
- 只計算「當前這一輪」的連續天數
- 必須包含今天或昨天
- 超過 1 天沒打卡會歸零

**新邏輯：**
- 計算「歷史上最長」的連續天數
- 不限時間，掃描所有打卡記錄
- 即使中斷，也會保留最高紀錄

---

## 修改檔案

### 1. Google Apps Script

**檔案：** `scripts/Code_CLEAN.js`

**修改內容：**
- 第 269-344 行：連續天數計算邏輯
- 改為從舊到新掃描所有日期
- 記錄最長的連續段

**需要執行：**
```
在 Google Apps Script 中：
1. 複製新的 Code_CLEAN.js 內容
2. 貼上覆蓋舊版本
3. 儲存
4. 執行「打卡系統」→「🔄 更新連續天數」
5. 檢查「打卡統計」工作表的 C 欄數值
```

### 2. 說明文件

**新增檔案：**
- `最高連續打卡說明.md` - 完整的新邏輯說明

**更新檔案：**
- `連續打卡計算說明.md` - 更新為指向新邏輯

---

## 測試驗證

### 使用測試資料

**檔案：** `test-data-2026.csv`

**預期結果：**

| 學員 | 打卡模式 | 累計 | 最高連續 |
|------|---------|------|---------|
| 學員001 | 完美連續 16 天 | 16 | **16** ✅ |
| 學員002 | 4天 + (缺) + 6天 + (缺) + 3天 | 13 | **6** ✅ |
| 學員003 | 晚加入，連續 7 天 | 7 | **7** ✅ |
| 學員004 | 3天 + (長期缺) + 3天 | 6 | **3** ✅ |
| 學員005 | 2天 + (缺) + 1天 + (缺) | 3 | **2** ✅ |

### 驗證步驟

1. **匯入測試資料**
   - 將 test-data-2026.csv 內容複製到 Google Sheets「表單回應」

2. **執行計算**
   - Google Apps Script：執行「🔄 更新連續天數」

3. **檢查結果**
   - 查看「打卡統計」工作表
   - C 欄（連續打卡天數）應顯示上表的數值

4. **查看 Log**
   - 在 Apps Script 執行記錄中
   - 前 3 位學員會顯示詳細的計算過程

---

## 範例說明：學員002

### 打卡記錄視覺化

```
週  日期      狀態        說明
─────────────────────────────────────
1   01-01    ✅         第一段開始
    01-02    ✅         │
    01-03    ✅         │
    01-04    ✅         第一段結束（4天）
    01-05    ❌         中斷！
    01-06    ✅         第二段開始
2   01-07    ✅         │
    01-08    ✅         │
    01-09    ✅         │
    01-10    ✅         │
    01-11    ✅         第二段結束（6天）← 最高紀錄
    01-12    ❌         中斷！
    01-13    ❌         中斷！
3   01-14    ✅         第三段開始
    01-15    ✅         │
    01-16    ✅         第三段結束（3天）
```

### 計算過程

```
掃描第一段：01-01 → 01-04 = 4天連續
記錄最高：4天

遇到中斷（缺01-05）

掃描第二段：01-06 → 01-11 = 6天連續
記錄最高：max(4, 6) = 6天

遇到中斷（缺01-12, 01-13）

掃描第三段：01-14 → 01-16 = 3天連續
記錄最高：max(6, 3) = 6天

最終結果：最高連續打卡 = 6天
```

---

## 前端顯示建議（可選）

### 更新標題和文字

**排行榜標題：**
```html
<!-- 舊 -->
<h2>🏅 連續打卡王</h2>

<!-- 新（建議） -->
<h2>🏅 連續打卡王（最高紀錄）</h2>
```

**個人統計：**
```html
<!-- 舊 -->
<div>🔥 連續打卡：X 天</div>

<!-- 新（建議） -->
<div>🏆 最高連續：X 天</div>
```

**注意：** 前端顯示已經從 Google Sheets 讀取 C 欄數值，數值會自動更新，只是顯示文字可以更明確。

---

## 常見問題

### Q: 為什麼要改成最高連續？

**A:** 更符合鼓勵學員的目標：
- 展現學員的潛力和努力
- 避免因一次失誤而歸零的挫折感
- 保留最佳成績，更有成就感

### Q: 會影響現有資料嗎？

**A:** 會！執行 `updateAllConsecutiveDays` 後，所有學員的連續天數都會重新計算。
- 完美連續的學員：數值不變
- 有中斷的學員：可能會增加（因為保留最高紀錄）

### Q: 今天沒打卡會怎樣？

**A:** 最高連續不會改變（歷史紀錄），但累計天數不會增加。

### Q: 前端需要修改程式碼嗎？

**A:** 不需要！前端已經正確讀取 Google Sheets 的 C 欄，數值會自動更新。
只是顯示文字建議改為「最高連續」更明確。

---

## 部署檢查清單

- [ ] 已複製新的 Code_CLEAN.js 到 Google Apps Script
- [ ] 已儲存並執行「🔄 更新連續天數」
- [ ] 已使用測試資料驗證計算正確
- [ ] 已查看前 3 位學員的計算 Log
- [ ] （可選）已更新前端顯示文字

---

## 相關文件

- 📄 **[最高連續打卡說明.md](./最高連續打卡說明.md)** - 完整邏輯說明
- 📄 **[連續打卡計算說明.md](./連續打卡計算說明.md)** - 快速參考
- 📊 **test-data-2026.csv** - 測試資料

---

## 技術細節

### 核心演算法

```javascript
// 從舊到新排序日期
sortedDates.sort((a, b) => a - b);

let maxConsecutiveDays = 1;
let currentConsecutive = 1;

for (let j = 1; j < sortedDates.length; j++) {
  const diff = (currentDate - previousDate) / (24 * 60 * 60 * 1000);

  if (diff === 1) {
    // 連續
    currentConsecutive++;
    maxConsecutiveDays = Math.max(maxConsecutiveDays, currentConsecutive);
  } else {
    // 中斷，重新開始
    currentConsecutive = 1;
  }
}

return maxConsecutiveDays; // 歷史最高紀錄
```

### 時間複雜度

- **O(n log n)**：排序日期
- **O(n)**：掃描計算
- **總計：O(n log n)**，n 為打卡天數

---

如有問題或需要協助，請參閱詳細文件或聯繫開發者。
