# 連續打卡計算說明（已更新為「最高連續」邏輯）

> ⚠️ **重要更新（2026-01-16）**
> 系統已從「當前連續打卡」改為「**最高連續打卡**」
> 詳細說明請參閱：[最高連續打卡說明.md](./最高連續打卡說明.md)

---

## 快速說明

### 新邏輯：最高連續打卡天數

**定義：** 學員在整個課程期間，曾經達到的**最長連續打卡紀錄**

**特點：**
- ✅ 保留歷史最佳成績
- ✅ 不受今天是否打卡影響
- ✅ 即使中斷，之前的最高紀錄仍保留
- ✅ 更具鼓勵性

---

## 計算範例

### 學員002 - 有中斷的情況

**打卡記錄：**
```
第一段：01-01, 01-02, 01-03, 01-04 (4天連續)
         ❌ 缺 01-05
第二段：01-06, 01-07, 01-08, 01-09, 01-10, 01-11 (6天連續) ← 最高
         ❌ 缺 01-12, 01-13
第三段：01-14, 01-15, 01-16 (3天連續)
```

**計算結果：最高連續打卡 = 6 天**

**說明：**
- 雖然最近只連續 3 天
- 但之前曾達到 6 天連續（01-06~11）
- 系統保留這個最高紀錄

---

## 與舊邏輯的差異

| 項目 | 舊邏輯（當前連續） | 新邏輯（最高連續） |
|-----|-----------------|-----------------|
| 計算方式 | 從最近往回算，遇中斷停止 | 掃描所有歷史，取最長段 |
| 是否需包含今天 | 必須（超過1天歸零） | 不需要 |
| 中斷後的影響 | 連續天數歸零 | 保留最高紀錄 |
| 學員002範例 | 3 天（只算最近） | 6 天（歷史最高） |

---

## 測試資料驗證

使用 test-data-2026.csv，預期結果：

| 學員 | 累計打卡 | **最高連續** | 說明 |
|------|---------|------------|------|
| 學員001 | 16 天 | **16 天** | 完美連續，無中斷 |
| 學員002 | 13 天 | **6 天** | 第二段最長（01-06~11） |
| 學員003 | 7 天 | **7 天** | 晚加入但完美連續 |
| 學員004 | 6 天 | **3 天** | 兩段都是 3 天 |
| 學員005 | 3 天 | **2 天** | 01-01~02 最長 |

---

## 程式碼位置

**Google Apps Script：**
- `scripts/Code_CLEAN.js`（第 269-344 行）

**核心邏輯：**
```javascript
let maxConsecutiveDays = 1;
let currentConsecutive = 1;

// 從舊到新掃描
for (let j = 1; j < sortedDates.length; j++) {
  const diff = (currentDate - previousDate) / (1天毫秒數);

  if (diff === 1) {
    currentConsecutive++;
    maxConsecutiveDays = Math.max(maxConsecutiveDays, currentConsecutive);
  } else {
    currentConsecutive = 1; // 中斷，重新計算
  }
}
```

---

## 常見問題

### Q: 為什麼要改成最高連續？

**A:** 更符合鼓勵原則：
- 展現學員的最佳表現
- 避免因一次失誤而挫折
- 更有成就感

### Q: 今天沒打卡會歸零嗎？

**A:** 不會！最高連續是歷史紀錄，不受今天影響。

### Q: 如果後來打出更長的連續會更新嗎？

**A:** 會！系統會持續追蹤並更新最高紀錄。

---

## 完整文檔

更詳細的說明、更多範例，請參閱：

📄 **[最高連續打卡說明.md](./最高連續打卡說明.md)**

包含：
- 詳細計算過程
- 5 個學員的完整範例
- 程式碼邏輯詳解
- UI 更新建議
- 舊邏輯對照表
