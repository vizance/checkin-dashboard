# 最高連續打卡天數說明

## 計算邏輯（2026-01-16 更新）

系統現已改為計算「**最高連續打卡天數**」，而非「當前連續打卡天數」。

---

## 新邏輯說明

### 核心概念

**最高連續打卡天數** = 歷史上曾經達到的最長連續紀錄

- ✅ **保留最佳成績**：即使後來中斷，之前的最高紀錄仍會保留
- ✅ **不受今天影響**：不管今天有沒有打卡，都不會影響最高紀錄
- ✅ **鼓勵性更強**：展現學員曾經達到的最佳表現

### 計算方式

1. **收集所有打卡日期**
2. **從舊到新排序**
3. **掃描所有連續段**
   - 如果相鄰兩天剛好相差 1 天 → 連續
   - 如果相差超過 1 天 → 中斷，重新開始計算
4. **記錄最長的連續段**

---

## 範例說明

### 範例 1：學員001 - 完美連續

**打卡記錄：**
```
01-01, 01-02, 01-03, 01-04, 01-05, 01-06, 01-07, 01-08,
01-09, 01-10, 01-11, 01-12, 01-13, 01-14, 01-15, 01-16
```

**計算過程：**
- 從 01-01 開始掃描
- 每一天都剛好相差 1 天
- 最長連續段 = 16 天

**結果：最高連續打卡 = 16 天** ✅

---

### 範例 2：學員002 - 中間有中斷

**打卡記錄：**
```
第一段：01-01, 01-02, 01-03, 01-04 (4天)
         ❌ 缺 01-05
第二段：01-06, 01-07, 01-08, 01-09, 01-10, 01-11 (6天)
         ❌ 缺 01-12, 01-13
第三段：01-14, 01-15, 01-16 (3天)
```

**計算過程：**
- 第一段連續：4 天
- 遇到中斷（缺 01-05），重新計算
- 第二段連續：6 天 ← **最高紀錄**
- 遇到中斷（缺 01-12, 01-13），重新計算
- 第三段連續：3 天

**結果：最高連續打卡 = 6 天** ✅

**說明：**
- 雖然最近只連續 3 天（01-14~16）
- 但之前曾達到 6 天連續（01-06~11）
- 系統保留最高紀錄 = 6 天

---

### 範例 3：學員003 - 晚加入但完美

**打卡記錄：**
```
❌ 01-01 到 01-09 未加入課程
01-10, 01-11, 01-12, 01-13, 01-14, 01-15, 01-16
```

**計算過程：**
- 從 01-10 開始，連續到 01-16
- 沒有中斷

**結果：最高連續打卡 = 7 天** ✅

---

### 範例 4：學員004 - 早期中斷

**打卡記錄：**
```
第一段：01-01, 01-02, 01-03 (3天)
         ❌ 缺 01-04 到 01-13（中斷 11 天）
第二段：01-14, 01-15, 01-16 (3天)
```

**計算過程：**
- 第一段連續：3 天
- 遇到長時間中斷
- 第二段連續：3 天

**結果：最高連續打卡 = 3 天** ✅

**說明：**
- 兩段都是 3 天連續
- 最高紀錄 = 3 天

---

### 範例 5：學員005 - 稀疏打卡

**打卡記錄：**
```
第一段：01-01, 01-02 (2天)
         ❌ 缺 01-03, 01-04
第二段：01-05 (1天)
         ❌ 01-06 之後都沒打卡
```

**計算過程：**
- 第一段連續：2 天 ← **最高紀錄**
- 遇到中斷
- 第二段：只有 1 天

**結果：最高連續打卡 = 2 天** ✅

---

## 與舊邏輯的差異

### 舊邏輯（當前連續打卡）

```
規則：
1. 最近打卡必須在今天或昨天
2. 從最近往回算，遇到中斷就停止
3. 超過 1 天沒打卡，連續天數歸零

範例（學員002）：
打卡記錄：01-06~11(6天), 缺12~13, 01-14~16(3天)
結果：3 天（只算最近這一輪）
```

### 新邏輯（最高連續打卡）

```
規則：
1. 不限時間，掃描所有歷史記錄
2. 找出所有連續段
3. 取最長的連續段

範例（學員002）：
打卡記錄：01-06~11(6天), 缺12~13, 01-14~16(3天)
結果：6 天（保留最高紀錄）
```

---

## 測試資料驗證

使用 test-data-2026.csv，執行 Apps Script 後應得到：

| 學員 | 打卡記錄 | 預期最高連續 | 說明 |
|------|---------|-------------|------|
| 學員001 | 01-01 到 01-16，完美連續 | **16 天** | 無中斷 |
| 學員002 | 有 3 段：4天, 6天, 3天 | **6 天** | 第二段最長 |
| 學員003 | 01-10 到 01-16，完美連續 | **7 天** | 晚加入但完美 |
| 學員004 | 有 2 段：3天, 3天 | **3 天** | 兩段相同 |
| 學員005 | 有 2 段：2天, 1天 | **2 天** | 第一段較長 |

---

## 程式碼邏輯（Code_CLEAN.js）

```javascript
// 計算最高連續打卡天數
let maxConsecutiveDays = 1; // 至少有 1 天
let currentConsecutive = 1;

// 從舊到新掃描所有打卡日期
for (let j = 1; j < sortedDates.length; j++) {
  const currentDate = sortedDates[j];
  const previousDate = sortedDates[j - 1];

  const diff = Math.floor((currentDate - previousDate) / (1000 * 60 * 60 * 24));

  if (diff === 1) {
    // 連續，增加計數
    currentConsecutive++;
    maxConsecutiveDays = Math.max(maxConsecutiveDays, currentConsecutive);
  } else {
    // 中斷，重新開始計算
    currentConsecutive = 1;
  }
}

// maxConsecutiveDays 就是最高連續打卡天數
```

---

## 常見問題

### Q1: 為什麼要改成「最高連續」而非「當前連續」？

**A:** 更符合「鼓勵」的原則：
- 展現學員曾經達到的最佳表現
- 即使後來中斷，也不會抹煞之前的努力
- 減少因一次失誤而歸零的挫折感

### Q2: 如果學員今天沒打卡，最高連續會歸零嗎？

**A:** 不會！最高連續是「歷史最佳紀錄」，今天的打卡與否不會影響這個數字。

### Q3: 如果學員後來又打出更長的連續，會更新嗎？

**A:** 會！系統會持續追蹤，如果後來有更長的連續段，就會更新最高紀錄。

### Q4: 這樣的話，排行榜會變成「歷史排名」嗎？

**A:** 是的！排行榜現在展示的是「誰曾經達到最長的連續打卡」，而非「誰現在正在連續打卡」。

### Q5: 如果我想看「當前連續」怎麼辦？

**A:** 目前系統只記錄「最高連續」。如果需要，可以額外增加一個欄位來追蹤「當前連續」。

---

## UI 顯示更新建議

### 排行榜標題
- **舊標題：** 🏅 連續打卡王
- **新標題：** 🏅 連續打卡王（最高紀錄）

### 個人統計卡片
- **舊顯示：** 🔥 連續打卡：X 天
- **新顯示：** 🏆 最高連續：X 天

### Tooltip 說明
- 當用戶 hover 在連續天數上時，顯示：
  「這是你曾經達到的最長連續打卡紀錄」

---

## 總結

**新邏輯的優點：**
1. ✅ 保留學員的最佳成績
2. ✅ 更有鼓勵性（不會因一次失誤歸零）
3. ✅ 展現學員的潛力和努力
4. ✅ 計算邏輯更簡單直觀

**注意事項：**
1. 修改後需重新執行 `updateAllConsecutiveDays`
2. 前端顯示文字建議更新為「最高連續」避免混淆
3. 向學員說明新的計算方式

---

## 相關檔案

- **後端計算：** `scripts/Code_CLEAN.js`（第 269-344 行）
- **週報讀取：** `scripts/WeeklyReport.js`（從統計表讀取，無需修改）
- **測試資料：** `test-data-2026.csv`
